# frontend/docker-mock/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
RUN npm install -g json-server

FROM node:18-alpine

# Создаем непривилегированного пользователя
RUN addgroup -g 1001 -S mockuser && \
    adduser -S mockuser -u 1001 -G mockuser

WORKDIR /app
USER mockuser

# Копируем json-server из builder
COPY --from=builder /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from=builder /usr/local/bin/json-server /usr/local/bin/json-server

# Копируем mock данные
COPY db.json .

# Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/users || exit 1

EXPOSE 3000

CMD ["json-server", "--host", "0.0.0.0", "--port", "3000", "db.json"]
